<!DOCTYPE html>
<html>

<head>
    <title>Stream-Up!</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <video id="video" autoplay="true">
        <source type='video/mp4' />
    </video>
    <button type="button" class="btn btn-primary" style="margin-left: 10px;" onclick="sendText();">Send</button>
    <div id="messages" class="form-control"></div>

    <script type="text/javascript">
    var video = document.querySelector('video');
    var messages = document.getElementById("messages");

    var queue = [];
    var buffer;

    var mediaSource;
    window.MediaSource = window.MediaSource || window.WebKitMediaSource;
    if (!!!window.MediaSource) {
    alert('MediaSource API is not available');
    } else {
        mediaSource = new MediaSource();
        mediaSource.addEventListener('sourceopen', function(e) {
            video.play();

            buffer = mediaSource.addSourceBuffer('video/mp4;codecs="avc1.64001f,mp4a.40.2"');
            buffer.addEventListener('update', function() { 
                if (queue.length > 0 && !buffer.updating) {
                    buffer.appendBuffer(queue.shift());
                }
            });
        }, false);

        video.src = window.URL.createObjectURL(mediaSource);

        var webSocket = new WebSocket('ws://localhost:8080/stream');
        webSocket.binaryType = 'arraybuffer';
        webSocket.onmessage = function(event){
            onMessage(event)
        };
        webSocket.onopen = function(event){
            onOpen(event)
        };
        webSocket.onclose = function(event){
            messages.innerHTML += "<br/>" + "Connection closed";
        };
    }	            

    function onOpen(event) {
        console.log('onOpen');
        var json = JSON.stringify({
            "type":"text",
            "data":"CONNECTED"
        });
        writeResponse(json);
    }
    function onMessage(event) {
        console.log('onMessage');
        if (event.data instanceof ArrayBuffer) {
        console.log('video chunk arrived');
        try {
                if (buffer.updating || queue.length > 0) {
                    queue.push(event.data);
                } else {
                    buffer.appendBuffer(event.data);
                }
            } catch (e) {
                console.log(e);
            }                       		
        } else {
            writeResponse(event.data);
        }
    }

    function sendText(){
        sendMessage("text", null);
    }

    function sendMessage(dataType, dataValue){
        var json = JSON.stringify({
            "type":dataType,
            "data":dataValue
        });
        webSocket.send(json);
    }

    function closeSocket(){
        webSocket.close();
    }

    function writeResponse(json){
        var response = JSON.parse(json);
        var output;
        switch (response.type){
            case "text":
                output = response.data;
                break;
            case "image":
                output = "<img src=\'" + response.data + "\'/>"
                break;
        }
        var messages = document.getElementById("messages");
        messages.innerHTML += "<br/>>" + output;
        messages.scrollTop = messages.scrollHeight; 	
    }
        </script>
</body>

</html>